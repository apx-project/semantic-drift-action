# APX Semantic Drift Action

Implements **Law #1 of Evolvable Software** – _“All systems drift unless governed.”_  
This action reads the semantic diff emitted by the APX CLI and:

* adds semantic labels to pull requests (`apx:pack=order_pack`, `apx:impact=security`, …)
* posts a Law #1 summary comment so reviewers see the context behind every change
* (optionally) fails the run if high/critical security drift is detected

It is intentionally focused on **Law #1**. The rest of the APX platform (Laws #2‑#7) covers constraints, lineage, continuous evolution, context-aware fitness, replay, and mathematical safety. By using this action you’re already producing the data that unlocks those later capabilities.

---

## TL;DR

```yaml
- uses: actions/checkout@v4

- name: Install APX CLI
  run: curl -fsSL https://raw.githubusercontent.com/apx-project/semantic-drift-action/main/scripts/install-apx.sh | bash

- name: Generate semantic diff
  run: |
    mkdir -p .apx
    apx harvest --ontology ontology/apx-onto.v1.yaml --output .apx/current.json
    apx semantic-diff --baseline .apx/baseline.json --current .apx/current.json --output .apx/semantic_diff.json

- name: APX Semantic Drift
  uses: apx-project/semantic-drift-action@v1
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    diff-path: '.apx/semantic_diff.json'
```

Done—every pull request now carries Law #1 labels + summary comments. Keep reading for inputs, schema tips, and the multi-platform installer scripts.

---

## Inputs

| Input | Required | Default | Description |
|-------|----------|---------|-------------|
| `github-token` | ✅ | — | Token with permission to label/comment on the PR (use `${{ secrets.GITHUB_TOKEN }}`) |
| `diff-path` | ❌ | `.apx/semantic_diff.json` | Path to the semantic diff generated by `apx semantic-diff` |
| `fail-on-security` | ❌ | `false` | If `true`, the action fails when high/critical security drift is detected |

## Outputs

| Output | Description |
|--------|-------------|
| `labels-applied` | Comma-separated list of labels that were added |
| `law` | Evolvable Software law enforced (`1`) |
| `security-alert` | `true` if a blocking security issue was found |

---

## Usage

```yaml
name: APX Semantic Drift

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  apx-semantic-drift:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup APX CLI
        uses: apx-project/setup-apx-action@v1
        with:
          version: latest

      - name: Generate semantic snapshots
        run: |
          mkdir -p .apx
          BASE="${{ github.base_ref }}"
          git fetch origin "$BASE" --depth=1
          git checkout "origin/$BASE"
          apx harvest --ontology apx_symbolic_100.yaml --output .apx/baseline.json
          git checkout -
          apx harvest --ontology apx_symbolic_100.yaml --output .apx/current.json
          apx semantic-diff \
            --baseline .apx/baseline.json \
            --current .apx/current.json \
            --output .apx/semantic_diff.json

      - name: APX Semantic Drift
        uses: apx-project/semantic-drift-action@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          diff-path: '.apx/semantic_diff.json'
          fail-on-security: 'true'
```

The action expects `semantic_diff.json` to contain data such as:

```jsonc
{
  "version": 1,
  "law": 1,
  "law_scope": "drift_visibility",
  "packs": ["order_pack", "iam_core"],
  "impacts": ["security", "payments"],
  "traits": ["pii_access", "order_total_constraint"],
  "alerts": [
    { "kind": "security", "severity": "high", "summary": "PII exfil risk" }
  ],
  "summary": {
    "changed": 5,
    "added": 1,
    "removed": 0
  },
  "extensions": {
    "constraints": [{ "id": "ORDER_TOTAL_NONNEGATIVE", "severity": "critical" }],
    "lineage": { "receipts": ["receipts/verify-build.json"] },
    "fitness": { "runner": { "robustness": 0.82 } },
    "proofs": [{ "kind": "smt", "reference": "receipts/verify-build.json" }]
  }
}
```

The schema is intentionally loose—the action looks for arrays named `packs`, `impacts`, `traits`, `labels`, and `alerts`. Anything it doesn’t understand is ignored, so you can extend the file with Law #2‑#7 metadata later without breaking existing users.

See `docs/semantic-drift-schema.md` for the canonical structure (including `extensions` fields reserved for constraints, lineage, replay, fitness, and proof metadata).

---

<details>
<summary><strong>Development Notes</strong></summary>

## Development

```bash
cd actions/semantic-drift-action
npm install
npm run build   # outputs dist/index.js
```

We commit `dist/index.js` so consumers don’t need any build tooling.

### Repository CI

The included workflow (`.github/workflows/ci.yml`) installs dependencies and runs `npm run build`. Add tests there when you’re ready.

### Scripts

| Script | Platform | Notes |
|--------|----------|-------|
| `scripts/install-apx.sh` | Linux | Uses `curl` + `sudo mv` to place `apx` under `/usr/local/bin`. |
| `scripts/install-apx-macos.sh` | macOS | Default arch `arm64`; set `APX_ARCH=amd64` for Intel runners. |
| `scripts/install-apx.ps1` | Windows | Downloads `apx.exe`, installs under `%ProgramFiles%\APX`, and appends to `GITHUB_PATH`. |

Prefer a single-step install? Use the companion `setup-apx` action (published from `actions/setup-apx/`) instead of these scripts whenever possible.

</details>

---

## Roadmap — The Seven Laws of Evolvable Software

| Law | Status | Description |
|-----|--------|-------------|
| **Law #1: Drift Visibility** | ✅ (this action) | Surface semantic meaning changes inside every PR |
| **Law #2: Constraints First** | Coming soon | Map diffs to constraint packs + CVS verdicts |
| **Law #3: Lineage & Receipts** | Coming soon | Trace semantic drift across receipts + AMC |
| **Law #4: Continuous Evolution** | Coming soon | GA/RL/MCTS-driven architecture exploration |
| **Law #5: Context-Aware Fitness** | Coming soon | Multi-device, multi-region modernization scoring |
| **Law #6: Replay Everything** | Coming soon | Deterministic replay bundles for drift decisions |
| **Law #7: Mathematical Safety** | Coming soon | SMT-backed obligation proofs + typed relaxations |

Install the action for free today (Law #1). Upgrade to APX Studio when you’re ready to enforce the rest.

