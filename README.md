# APX Semantic SemanticDebt Action

[![Use on GitHub Marketplace](https://img.shields.io/badge/Use%20on-GitHub%20Marketplace-333?logo=github)](https://github.com/marketplace/actions/apx-semantic-semantic_debt)
[![APX CLI](https://img.shields.io/badge/APX-CLI-blue)](https://apx.guide)

Implements **Law¬†#1 of Evolvable Software** ‚Äì _‚ÄúAll systems semantic_debt unless governed.‚Äù_  
This action reads the semantic diff emitted by the APX CLI and:

* adds semantic labels to pull requests (`apx:pack=order_pack`, `apx:impact=security`, ‚Ä¶)
* posts a Law¬†#1 summary comment so reviewers see the context behind every change
* (optionally) fails the run if high/critical security semantic_debt is detected
* can incorporate PackSpec/motifs/risks from diagram harvesting outputs (`diagram_inference.json`, `warnings.json`) when you run `apx harvest-diagram --reconstruct-drawio` upstream

It is intentionally focused on **Law¬†#1**. The rest of the APX platform (Laws¬†#2‚Äë#7) covers constraints, lineage, continuous evolution, context-aware fitness, replay, and mathematical safety. By using this action you‚Äôre already producing the data that unlocks those later capabilities.

---

## TL;DR

```yaml
- uses: actions/checkout@v4
- uses: apx-project/setup-apx-action@v1
- name: Semantic Debt scan + diff
  run: |
    mkdir -p .apx
    apx init --preset config-guard-lite --service checkout --namespace checkout --environment "${GITHUB_REF_NAME:-dev}" --out packs/config-guard/checkout.yaml || true
    cp packs/config-guard/checkout.yaml .apx/pack.yaml || true
    apx scan --path . --json --output .apx/semantic_debt_scan.json
    apx semantic-diff --baseline .apx/baseline.json --current .apx/current.json --output .apx/semantic_diff.json
- uses: apx-project/semantic-semantic_debt-action@v1
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    diff-path: '.apx/semantic_diff.json'
    scan-path: '.apx/semantic_debt_scan.json'
```

The Config Guard preset + copy step ensures `.apx/pack.yaml` exists for every run, so PackSpec Everywhere telemetry and Studio Lite stay in lockstep with Law‚ÄØ#1 installs.

Done‚Äîevery pull request now carries Law¬†#1 labels + summary comments. Keep reading for inputs, schema tips, and the multi-platform installer scripts, or jump to `docs/semantic_debt_scanner.md` for the full scanner playbook (CLI arguments, JSON schema, GTM demos).

---

## Inputs

| Input | Required | Default | Description |
|-------|----------|---------|-------------|
| `github-token` | ‚úÖ | ‚Äî | Token with permission to label/comment on the PR (use `${{ secrets.GITHUB_TOKEN }}`) |
| `diff-path` | ‚ùå | `.apx/semantic_diff.json` | Path to the semantic diff generated by `apx semantic-diff` |
| `scan-path` | ‚ùå | `.apx/semantic_debt_scan.json` | JSON produced by `apx scan --json --output ‚Ä¶` (adds score/cost to the PR summary) |
| `fail-on-security` | ‚ùå | `false` | If `true`, the action fails when high/critical security semantic_debt is detected |

## Outputs

| Output | Description |
|--------|-------------|
| `labels-applied` | Comma-separated list of labels that were added |
| `law` | Evolvable Software law enforced (`1`) |
| `security-alert` | `true` if a blocking security issue was found |
| `semantic-debt-score` | Debt score reported by `apx scan`, if provided |

---

## Usage

```yaml
name: APX Semantic SemanticDebt

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  apx-semantic-semantic_debt:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup APX CLI
        uses: apx-project/setup-apx-action@v1
        with:
          version: latest

      - name: Generate semantic snapshots
        run: |
          mkdir -p .apx
          apx init --preset config-guard-lite \
            --service "${{ github.repository }}" \
            --namespace "${{ github.repository_owner }}" \
            --environment "${{ github.ref_name }}" \
            --out "packs/config-guard/${{ github.repository }}.yaml" || true
          cp "packs/config-guard/${{ github.repository }}.yaml" .apx/pack.yaml || true
          BASE="${{ github.base_ref }}"
          git fetch origin "$BASE" --depth=1
          git checkout "origin/$BASE"
          apx harvest --ontology apx_symbolic_100.yaml --output .apx/baseline.json
          git checkout -
          apx harvest --ontology apx_symbolic_100.yaml --output .apx/current.json
          apx semantic-diff \
            --baseline .apx/baseline.json \
            --current .apx/current.json \
            --output .apx/semantic_diff.json

      - name: Semantic Debt scan
        run: |
          apx scan --path . --json --output .apx/semantic_debt_scan.json

      - name: APX Semantic SemanticDebt
        uses: apx-project/semantic-semantic_debt-action@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          diff-path: '.apx/semantic_diff.json'
          scan-path: '.apx/semantic_debt_scan.json'
          fail-on-security: 'true'

# Optional: include diagram harvesting for PackSpec + motifs/risks
- name: Harvest diagram (PNG or draw.io)
  run: |
    mkdir -p .apx/harvest
    apx harvest-diagram --input diagrams/arch.png \
      --output-dir .apx/harvest \
      --reconstruct-drawio \
      --verify-constraints
    # You can feed .apx/harvest/diagram_inference.json and warnings.json into PR summaries
```

The action expects `semantic_diff.json` to contain data such as:

```jsonc
{
  "version": 1,
  "law": 1,
  "law_scope": "drift_visibility",
  "packs": ["order_pack", "iam_core"],
  "impacts": ["security", "payments"],
  "traits": ["pii_access", "order_total_constraint"],
  "alerts": [
    { "kind": "security", "severity": "high", "summary": "PII exfil risk" }
  ],
  "summary": {
    "changed": 5,
    "added": 1,
    "removed": 0
  },
  "extensions": {
    "constraints": [{ "id": "ORDER_TOTAL_NONNEGATIVE", "severity": "critical" }],
    "lineage": { "receipts": ["receipts/verify-build.json"] },
    "fitness": { "runner": { "robustness": 0.82 } },
    "proofs": [{ "kind": "smt", "reference": "receipts/verify-build.json" }]
  }
}
```

The schema is intentionally loose‚Äîthe action looks for arrays named `packs`, `impacts`, `traits`, `labels`, and `alerts`. Anything it doesn‚Äôt understand is ignored, so you can extend the file with Law¬†#2‚Äë#7 metadata later without breaking existing users.

See `docs/semantic-semantic_debt-schema.md` for the canonical structure (including `extensions` fields reserved for constraints, lineage, replay, fitness, and proof metadata).

---

<details>
<summary><strong>Development Notes</strong></summary>

## Development

```bash
cd actions/semantic-semantic_debt-action
npm install
npm run build   # outputs dist/index.js
```

We commit `dist/index.js` so consumers don‚Äôt need any build tooling.

## PR comment template (use this or let the action post it)

```markdown
## üìä APX Semantic Debt Report

| Metric | Value | Œî |
|--------|-------|---|
| Semantic Debt | $2,400 | ‚Üì $800 |
| Constraints | 12 | +2 |
| Violations | 0 | ‚úì |

**This PR reduces semantic debt by 25%** üéâ

[View full report](https://apx.guide/r/abc123) ‚Ä¢ [What is semantic debt?](https://apx.guide/semantic-debt) ‚Ä¢ [What is APX?](https://apx.guide)
```

---

## Roadmap ‚Äî The Seven Laws of Evolvable Software

| Law | Status | Description |
|-----|--------|-------------|
| **Law¬†#1: SemanticDebt Visibility** | ‚úÖ (this action) | Surface semantic meaning changes inside every PR |
| **Law¬†#2: Constraints First** | Coming soon | Map diffs to constraint packs + CVS verdicts |
| **Law¬†#3: Lineage & Receipts** | Coming soon | Trace semantic semantic_debt across receipts + AMC |
| **Law¬†#4: Continuous Evolution** | Coming soon | GA/RL/MCTS-driven architecture exploration |
| **Law¬†#5: Context-Aware Fitness** | Coming soon | Multi-device, multi-region modernization scoring |
| **Law¬†#6: Replay Everything** | Coming soon | Deterministic replay bundles for semantic_debt decisions |
| **Law¬†#7: Mathematical Safety** | Coming soon | SMT-backed obligation proofs + typed relaxations |

Install the action for free today (Law¬†#1). Upgrade to APX Studio when you‚Äôre ready to enforce the rest.

## License

This action is distributed under the Apache License 2.0 (see `LICENSE`).

[![Use on GitHub Marketplace](https://img.shields.io/badge/Use%20on-GitHub%20Marketplace-333?logo=github)](https://github.com/marketplace/actions/apx-semantic-semantic_debt)

### Repository CI

The included workflow (`.github/workflows/ci.yml`) installs dependencies and runs `npm run build`. Add tests there when you‚Äôre ready.

### Scripts

| Script | Platform | Notes |
|--------|----------|-------|
| `scripts/install-apx.sh` | Linux | Uses `curl` + `sudo mv` to place `apx` under `/usr/local/bin`. |
| `scripts/install-apx-macos.sh` | macOS | Default arch `arm64`; set `APX_ARCH=amd64` for Intel runners. |
| `scripts/install-apx.ps1` | Windows | Downloads `apx.exe`, installs under `%ProgramFiles%\APX`, and appends to `GITHUB_PATH`. |

Prefer a single-step install? Use the companion `setup-apx` action (published from `actions/setup-apx/`) instead of these scripts whenever possible.

</details>

---

## Roadmap ‚Äî The Seven Laws of Evolvable Software

| Law | Status | Description |
|-----|--------|-------------|
| **Law¬†#1: SemanticDebt Visibility** | ‚úÖ (this action) | Surface semantic meaning changes inside every PR |
| **Law¬†#2: Constraints First** | Coming soon | Map diffs to constraint packs + CVS verdicts |
| **Law¬†#3: Lineage & Receipts** | Coming soon | Trace semantic semantic_debt across receipts + AMC |
| **Law¬†#4: Continuous Evolution** | Coming soon | GA/RL/MCTS-driven architecture exploration |
| **Law¬†#5: Context-Aware Fitness** | Coming soon | Multi-device, multi-region modernization scoring |
| **Law¬†#6: Replay Everything** | Coming soon | Deterministic replay bundles for semantic_debt decisions |
| **Law¬†#7: Mathematical Safety** | Coming soon | SMT-backed obligation proofs + typed relaxations |

Install the action for free today (Law¬†#1). Upgrade to APX Studio when you‚Äôre ready to enforce the rest.

## License

This action is distributed under the Apache License 2.0 (see `LICENSE`).

[![Use on GitHub Marketplace](https://img.shields.io/badge/Use%20on-GitHub%20Marketplace-333?logo=github)](https://github.com/marketplace/actions/apx-semantic-semantic_debt)

